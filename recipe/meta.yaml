{% set version = "20220623.0" %}

package:
  name: abseil-cpp
  version: {{ version }}

source:
  url: https://github.com/abseil/abseil-cpp/archive/{{ version }}.tar.gz
  sha256: dcf71b9cba8dc0ca9940c4b316a0c796be8fab42b070bb6b7cab62b48f0e66c4
  patches:
    - patches/0001-patch-out-the-build-issue-on-clang4-osx.patch
    - patches/0002-fix-for-linking-to-the-CoreFoundation-framework-on-O.patch
    - patches/0003-remove-ignore-4221-from-ABSL_MSVC_LINKOPTS.patch
    - patches/0004-add-missing-osx-workaround.patch

build:
  number: 1

outputs:
  - name: abseil-cpp
    script: build-abseil.sh   # [unix]
    script: build-abseil.bat  # [win]
    build:
      run_exports:
        - {{ pin_subpackage("abseil-cpp", max_pin="x.x") }}

    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - cmake
        - ninja

    {% set absl_libs = [
        "base", "civil_time", "cord", "cordz_functions", "cordz_handle", "cordz_info",
        "cordz_sample_token", "examine_stack", "exponential_biased", "failure_signal_handler",
        "flags", "flags_commandlineflag", "flags_config", "flags_marshalling", "flags_parse",
        "flags_private_handle_accessor", "flags_program_name", "flags_reflection", "flags_usage",
        "hash", "hashtablez_sampler", "int128", "log_severity", "low_level_hash", "periodic_sampler",
        "random_distributions", "random_seed_gen_exception", "random_seed_sequences", "raw_hash_set",
        "scoped_set_env", "spinlock_wait", "stacktrace", "status", "statusor", "strerror", "strings",
        "symbolize", "synchronization", "time", "time_zone"
    ] %}
    test:
      commands:
        # windows (DLL + import library)
        - if not exist %LIBRARY_BIN%\\abseil_dll.dll exit 1  # [win]
        - if not exist %LIBRARY_LIB%\\abseil_dll.lib exit 1  # [win]

        # absl_libs
        {% for each_lib in absl_libs %}
        # presence of shared libs
        - test -f $PREFIX/lib/libabsl_{{ each_lib }}${SHLIB_EXT}      # [unix]
        # absence of static libs
        - test ! -f $PREFIX/lib/libabsl_{{ each_lib }}.a              # [unix]
        # TODO: do we want to get rid of the static windows libs?
        # - if exist %LIBRARY_LIB%\\absl_{{ each_lib }}.lib exit 1      # [win]
        {% endfor %}

about:
  home: https://github.com/abseil/abseil-cpp
  license: Apache-2.0
  license_family: Apache
  license_file: LICENSE
  summary: Abseil Common Libraries (C++)
  description: |
    Abseil is an open-source collection of C++ code (compliant to C++11)
    designed to augment the C++ standard library.
  doc_url: https://github.com/abseil/abseil-cpp
  dev_url: https://github.com/abseil/abseil-cpp

extra:
  recipe-maintainers:
    - njzjz
    - bluescarni
    - xhochy
    - h-vetinari
